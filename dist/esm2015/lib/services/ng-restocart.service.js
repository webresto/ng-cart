import { Injectable } from '@angular/core';
import { BehaviorSubject, throwError, from } from 'rxjs';
import { catchError, filter, map, switchMap, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@webresto/ng-core";
export class NgRestoCartService {
    constructor(net, eventer) {
        this.net = net;
        this.eventer = eventer;
        this.cartID = this.getCartId();
        this.cart = new BehaviorSubject(null);
        this.modifires = new BehaviorSubject([]);
        this.OrderFormChange = new BehaviorSubject(null);
        this.modifiresMessage = new BehaviorSubject([]);
        this.restrictions$ = this.net.get(`/restrictions`);
    }
    getCartId() {
        return localStorage.getItem('cartID');
    }
    getCart() {
        return this.net.get(`/cart${this.cartID ? '?cartId=' + this.cartID : ''}`).pipe(switchMap(data => {
            if (!data) {
                this.removeCartId();
            }
            ;
            return data ? from([data]) : this.net.get(`/cart}`);
        }), switchMap(data => {
            if (!this.cartID) {
                this.setCartId(data.cart.cartId);
            }
            ;
            if (data.cart.state == 'ORDER') {
                return throwError(new Error('Cart in order state'));
            }
            else {
                this.cart.next(data.cart);
            }
            ;
            return this.cart;
        }), catchError(err => {
            this.removeCartId();
            return throwError(err);
        }));
    }
    addDishToCart(data) {
        if (this.modifiresMessage.value.length) {
            this.modifiresMessage.value.forEach(message => {
                this.eventer.emitMessageEvent(message);
            });
            return;
        }
        this.net.put('/cart/add', data).subscribe(res => {
            this.setCartId(res.cart.cartId);
            this.cart.next(res.cart);
            this.cartID = res.cart.cartId;
            /*this.eventer.emitMessageEvent(
             new EventMessage('success', 'Успех', 'Блюдо добавлено в корзину')
             );*/
        }, () => {
            /*this.eventer.emitMessageEvent(
             new EventMessage('error', 'Ошибка', 'Не удалось добавить блюдо')
             )*/
        });
    }
    addDishToCart$(data) {
        if (this.modifiresMessage.value.length) {
            this.modifiresMessage.value.forEach(message => {
                this.eventer.emitMessageEvent(message);
            });
            return from([null]);
        }
        return this.net.put('/cart/add', data)
            .pipe(tap(res => {
            this.setCartId(res.cart.cartId);
            this.cart.next(res.cart);
            this.cartID = res.cart.cartId;
        }));
    }
    setDishCountToCart(dishId, amount) {
        this.net.post('/cart/set', {
            dishId: dishId,
            cartId: this.cartID,
            amount: amount
        }).subscribe(res => {
            this.setCartId(res.cart.cartId);
            this.cart.next(res.cart);
            this.cartID = res.cart.cartId;
            /*this.eventer.emitMessageEvent(
             new EventMessage('success', 'Успех', 'Изменено количество')
             );*/
        }, () => {
            /*this.eventer.emitMessageEvent(
             new EventMessage('error', 'Ошибка', 'Не удалось изменить количество')
             )*/
        });
    }
    setDishComment(dishId, comment) {
        return this.net.post('/cart/setcomment', {
            dishId: dishId,
            cartId: this.cartID,
            comment: comment
        }).pipe(tap(res => {
            this.setCartId(res.cart.cartId);
            this.cart.next(res.cart);
            this.cartID = res.cart.cartId;
        }, () => { }));
    }
    removeDishFromCart$(dishId, amount) {
        return this.net.put('/cart/remove', {
            dishId: dishId,
            cartId: this.cartID,
            amount: amount
        })
            .pipe(tap(result => {
            this.setCartId(result.cart.cartId);
            this.cart.next(result.cart);
            this.cartID = result.cart.cartId;
        }));
    }
    removeDishFromCart(dishId, amount) {
        this.net.put('/cart/remove', {
            dishId: dishId,
            cartId: this.cartID,
            amount: amount
        }).subscribe(result => {
            this.setCartId(result.cart.cartId);
            this.cart.next(result.cart);
            this.cartID = result.cart.cartId;
            /*this.eventer.emitMessageEvent(
             new EventMessage('success', 'Успех', 'Блюдо успешно удалено')
             );*/
        }, () => {
            /*this.eventer.emitMessageEvent(
             new EventMessage('error', 'Ошибка', 'Не удалось удалить блюдо')
             )*/
        });
    }
    checkoutCart(data) {
        let order = {
            cartId: this.cartID,
            address: {
                streetId: data.street.id,
                home: data.house,
                housing: data.housing,
                // index: "1278",
                entrance: data.entrance,
                floor: data.floor,
                apartment: data.apartment
            },
            customer: {
                phone: data.phone,
                name: data.name,
                mail: data.email || undefined
            }
        };
        return this.orderCart(order);
    }
    orderCart(data) {
        return this.net.post('/order', data)
            .pipe(tap(result => {
            this.setCartId(result.cart.cartId);
            this.cart.next(result.cart);
            this.cartID = result.cart.cartId;
            /*this.eventer.emitMessageEvent(
             new EventMessage('success', 'Успех', 'Заказ упешно оформлен')
             );*/
        }, error => {
            console.log("Ошибка оформления!", error);
            if (error.error && error.error.cart) {
                this.setCartId(error.error.cart.cartId);
                this.cart.next(error.error.cart);
                this.cartID = error.error.cart.cartId;
            }
            /*if (error.message) {
              this.eventer.emitMessageEvent(
                new EventMessage(error.message.type, error.message.title, error.message.body)
              );
            } else {
              this.eventer.emitMessageEvent(
                new EventMessage('error', 'Ошибка', 'Не удалось оформить заказ')
              );
            }*/
        }));
    }
    checkStreetV2(data) {
        return this.net.post('/check', data)
            .pipe(tap(result => {
            this.setCartId(result.cart.cartId);
            this.cart.next(result.cart);
            this.cartID = result.cart.cartId;
        }, () => { }));
    }
    checkStreet(data) {
        this.net.post('/check', data).subscribe(res => {
            this.setCartId(res.cart.cartId);
            this.cart.next(res.cart);
            this.cartID = res.cart.cartId;
        }, error => {
            if (error.error) {
                if (error.error.cart) {
                    this.setCartId(error.error.cart.cartId);
                    this.cart.next(error.error.cart);
                    this.cartID = error.error.cart.cartId;
                }
                /*this.eventer.emitMessageEvent(
                 new EventMessage(error.error.message.type, error.error.message.title, error.error.message.body)
                 );*/
            }
        });
    }
    setCartId(cartID) {
        localStorage.setItem('cartID', cartID);
    }
    removeCartId() {
        localStorage.removeItem('cartID');
    }
    userCart() {
        return this.cart;
    }
    setModifires(modifires, messages) {
        this.modifires.next(modifires);
        if (messages) {
            this.modifiresMessage.next(messages);
        }
        ;
    }
    getModifires() {
        return this.modifires.pipe();
    }
    productInCart(product) {
        return this.cart.pipe(filter(cart => 'cartId' in cart), map(cart => {
            var _a;
            return !!(cart && ((_a = cart === null || cart === void 0 ? void 0 : cart.dishes) === null || _a === void 0 ? void 0 : _a.find(dishInCart => dishInCart.dish.id === product.id)));
        }));
    }
    getPickupPoints() {
        return this.net.get('/pickupaddreses?cartId=string');
    }
    getPaymentMethods() {
        return this.net.get('/paymentmethods');
    }
}
NgRestoCartService.ɵfac = function NgRestoCartService_Factory(t) { return new (t || NgRestoCartService)(i0.ɵɵinject(i1.NetService), i0.ɵɵinject(i1.EventerService)); };
NgRestoCartService.ɵprov = i0.ɵɵdefineInjectable({ token: NgRestoCartService, factory: NgRestoCartService.ɵfac, providedIn: 'root' });
/*@__PURE__*/ (function () { i0.ɵsetClassMetadata(NgRestoCartService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.NetService }, { type: i1.EventerService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcmVzdG9jYXJ0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vc3JjLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL25nLXJlc3RvY2FydC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFjLGVBQWUsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7OztBQVd6RSxNQUFNLE9BQU8sa0JBQWtCO0lBUTdCLFlBQW9CLEdBQWUsRUFBVSxPQUF1QjtRQUFoRCxRQUFHLEdBQUgsR0FBRyxDQUFZO1FBQVUsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFQcEUsV0FBTSxHQUFXLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNsQyxTQUFJLEdBQTBCLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hELGNBQVMsR0FBeUIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDMUQsb0JBQWUsR0FBRyxJQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU1QyxxQkFBZ0IsR0FBb0MsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFJNUUsa0JBQWEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBb0IsZUFBZSxDQUFDLENBQUE7SUFGUSxDQUFDO0lBSXpFLFNBQVM7UUFDUCxPQUFPLFlBQVksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELE9BQU87UUFDTCxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFpQixRQUFRLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUs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O1NBQ3RDO1FBQUEsQ0FBQztJQUNKLENBQUM7SUFFRCxZQUFZO1FBQ1YsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCxhQUFhLENBQUMsT0FBcUI7UUFDakMsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDbkIsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxFQUNoQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7O1lBQ1QsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLFdBQUksSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLE1BQU0sMENBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssT0FBTyxDQUFDLEVBQUUsRUFBQyxDQUFDLENBQUE7UUFDeEYsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRCxlQUFlO1FBQ2IsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBZ0IsK0JBQStCLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQsaUJBQWlCO1FBQ2YsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBa0IsaUJBQWlCLENBQUMsQ0FBQztJQUMxRCxDQUFDOztvRkFqU1Usa0JBQWtCOzBEQUFsQixrQkFBa0IsV0FBbEIsa0JBQWtCLG1CQUZqQixNQUFNO2tEQUVQLGtCQUFrQjtjQUg5QixVQUFVO2VBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCwgdGhyb3dFcnJvciwgZnJvbSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBjYXRjaEVycm9yLCBmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7XHJcbiAgTmV0U2VydmljZSxcclxuICBFdmVudGVyU2VydmljZSxcclxuICBFdmVudE1lc3NhZ2VcclxufSBmcm9tICdAd2VicmVzdG8vbmctY29yZSc7XHJcblxyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgTmdSZXN0b0NhcnRTZXJ2aWNlIHtcclxuICBjYXJ0SUQ6IHN0cmluZyA9IHRoaXMuZ2V0Q2FydElkKCk7XHJcbiAgY2FydDogQmVoYXZpb3JTdWJqZWN0PENhcnQ+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChudWxsKTtcclxuICBtb2RpZmlyZXM6IEJlaGF2aW9yU3ViamVjdDxhbnk+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XHJcbiAgT3JkZXJGb3JtQ2hhbmdlID0gbmV3IEJlaGF2aW9yU3ViamVjdChudWxsKTtcclxuXHJcbiAgbW9kaWZpcmVzTWVzc2FnZTogQmVoYXZpb3JTdWJqZWN0PEV2ZW50TWVzc2FnZVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5ldDogTmV0U2VydmljZSwgcHJpdmF0ZSBldmVudGVyOiBFdmVudGVyU2VydmljZSkgeyB9XHJcblxyXG4gIHJlc3RyaWN0aW9ucyQgPSB0aGlzLm5ldC5nZXQ8UmVzdHJpY3Rpb25zT3JkZXI+KGAvcmVzdHJpY3Rpb25zYClcclxuXHJcbiAgZ2V0Q2FydElkKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2NhcnRJRCcpO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q2FydCgpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5nZXQ8eyBjYXJ0OiBDYXJ0IH0+KGAvY2FydCR7dGhpcy5jYXJ0SUQgPyAnP2NhcnRJZD0nICsgdGhpcy5jYXJ0SUQgOiAnJ31gKS5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoZGF0YSA9PiB7XHJcbiAgICAgICAgaWYgKCFkYXRhKSB7XHJcbiAgICAgICAgICB0aGlzLnJlbW92ZUNhcnRJZCgpO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIGRhdGEgPyBmcm9tKFtkYXRhXSkgOiB0aGlzLm5ldC5nZXQ8eyBjYXJ0OiBDYXJ0IH0+KGAvY2FydH1gKVxyXG4gICAgICB9KSxcclxuICAgICAgc3dpdGNoTWFwKFxyXG4gICAgICAgIGRhdGEgPT4ge1xyXG4gICAgICAgICAgaWYgKCF0aGlzLmNhcnRJRCkge1xyXG4gICAgICAgICAgICB0aGlzLnNldENhcnRJZChkYXRhLmNhcnQuY2FydElkKTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICBpZiAoZGF0YS5jYXJ0LnN0YXRlID09ICdPUkRFUicpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IobmV3IEVycm9yKCdDYXJ0IGluIG9yZGVyIHN0YXRlJykpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jYXJ0Lm5leHQoZGF0YS5jYXJ0KTtcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5jYXJ0O1xyXG4gICAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKGVyciA9PiB7XHJcbiAgICAgICAgdGhpcy5yZW1vdmVDYXJ0SWQoKTtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnIpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGFkZERpc2hUb0NhcnQoZGF0YSkge1xyXG4gICAgaWYgKHRoaXMubW9kaWZpcmVzTWVzc2FnZS52YWx1ZS5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5tb2RpZmlyZXNNZXNzYWdlLnZhbHVlLmZvckVhY2gobWVzc2FnZSA9PiB7XHJcbiAgICAgICAgdGhpcy5ldmVudGVyLmVtaXRNZXNzYWdlRXZlbnQobWVzc2FnZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5uZXQucHV0KCcvY2FydC9hZGQnLCBkYXRhKS5zdWJzY3JpYmUoXHJcbiAgICAgIHJlcyA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXRDYXJ0SWQocmVzLmNhcnQuY2FydElkKTtcclxuICAgICAgICB0aGlzLmNhcnQubmV4dChyZXMuY2FydCk7XHJcbiAgICAgICAgdGhpcy5jYXJ0SUQgPSByZXMuY2FydC5jYXJ0SWQ7XHJcblxyXG4gICAgICAgIC8qdGhpcy5ldmVudGVyLmVtaXRNZXNzYWdlRXZlbnQoXHJcbiAgICAgICAgIG5ldyBFdmVudE1lc3NhZ2UoJ3N1Y2Nlc3MnLCAn0KPRgdC/0LXRhScsICfQkdC70Y7QtNC+INC00L7QsdCw0LLQu9C10L3QviDQsiDQutC+0YDQt9C40L3RgycpXHJcbiAgICAgICAgICk7Ki9cclxuXHJcbiAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAvKnRoaXMuZXZlbnRlci5lbWl0TWVzc2FnZUV2ZW50KFxyXG4gICAgICAgICBuZXcgRXZlbnRNZXNzYWdlKCdlcnJvcicsICfQntGI0LjQsdC60LAnLCAn0J3QtSDRg9C00LDQu9C+0YHRjCDQtNC+0LHQsNCy0LjRgtGMINCx0LvRjtC00L4nKVxyXG4gICAgICAgICApKi9cclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBhZGREaXNoVG9DYXJ0JChkYXRhKSB7XHJcbiAgICBpZiAodGhpcy5tb2RpZmlyZXNNZXNzYWdlLnZhbHVlLmxlbmd0aCkge1xyXG4gICAgICB0aGlzLm1vZGlmaXJlc01lc3NhZ2UudmFsdWUuZm9yRWFjaChtZXNzYWdlID0+IHtcclxuICAgICAgICB0aGlzLmV2ZW50ZXIuZW1pdE1lc3NhZ2VFdmVudChtZXNzYWdlKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBmcm9tKFtudWxsXSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMubmV0LnB1dCgnL2NhcnQvYWRkJywgZGF0YSlcclxuICAgICAgLnBpcGUoXHJcbiAgICAgICAgdGFwKHJlcyA9PiB7XHJcbiAgICAgICAgICB0aGlzLnNldENhcnRJZChyZXMuY2FydC5jYXJ0SWQpO1xyXG4gICAgICAgICAgdGhpcy5jYXJ0Lm5leHQocmVzLmNhcnQpO1xyXG4gICAgICAgICAgdGhpcy5jYXJ0SUQgPSByZXMuY2FydC5jYXJ0SWQ7XHJcbiAgICAgICAgfSlcclxuICAgICAgKTtcclxuICB9XHJcblxyXG4gIHNldERpc2hDb3VudFRvQ2FydChkaXNoSWQsIGFtb3VudCkge1xyXG4gICAgdGhpcy5uZXQucG9zdCgnL2NhcnQvc2V0Jywge1xyXG4gICAgICBkaXNoSWQ6IGRpc2hJZCxcclxuICAgICAgY2FydElkOiB0aGlzLmNhcnRJRCxcclxuICAgICAgYW1vdW50OiBhbW91bnRcclxuICAgIH0pLnN1YnNjcmliZShcclxuICAgICAgcmVzID0+IHtcclxuICAgICAgICB0aGlzLnNldENhcnRJZChyZXMuY2FydC5jYXJ0SWQpO1xyXG4gICAgICAgIHRoaXMuY2FydC5uZXh0KHJlcy5jYXJ0KTtcclxuICAgICAgICB0aGlzLmNhcnRJRCA9IHJlcy5jYXJ0LmNhcnRJZDtcclxuICAgICAgICAvKnRoaXMuZXZlbnRlci5lbWl0TWVzc2FnZUV2ZW50KFxyXG4gICAgICAgICBuZXcgRXZlbnRNZXNzYWdlKCdzdWNjZXNzJywgJ9Cj0YHQv9C10YUnLCAn0JjQt9C80LXQvdC10L3QviDQutC+0LvQuNGH0LXRgdGC0LLQvicpXHJcbiAgICAgICAgICk7Ki9cclxuICAgICAgfSwgKCkgPT4ge1xyXG4gICAgICAgIC8qdGhpcy5ldmVudGVyLmVtaXRNZXNzYWdlRXZlbnQoXHJcbiAgICAgICAgIG5ldyBFdmVudE1lc3NhZ2UoJ2Vycm9yJywgJ9Ce0YjQuNCx0LrQsCcsICfQndC1INGD0LTQsNC70L7RgdGMINC40LfQvNC10L3QuNGC0Ywg0LrQvtC70LjRh9C10YHRgtCy0L4nKVxyXG4gICAgICAgICApKi9cclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBzZXREaXNoQ29tbWVudChkaXNoSWQsIGNvbW1lbnQpIHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvY2FydC9zZXRjb21tZW50Jywge1xyXG4gICAgICBkaXNoSWQ6IGRpc2hJZCxcclxuICAgICAgY2FydElkOiB0aGlzLmNhcnRJRCxcclxuICAgICAgY29tbWVudDogY29tbWVudFxyXG4gICAgfSkucGlwZSh0YXAoXHJcbiAgICAgIHJlcyA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXRDYXJ0SWQocmVzLmNhcnQuY2FydElkKTtcclxuICAgICAgICB0aGlzLmNhcnQubmV4dChyZXMuY2FydCk7XHJcbiAgICAgICAgdGhpcy5jYXJ0SUQgPSByZXMuY2FydC5jYXJ0SWQ7XHJcblxyXG4gICAgICB9LCAoKSA9PiB7fVxyXG4gICAgKSlcclxuXHJcbiAgfVxyXG5cclxuICByZW1vdmVEaXNoRnJvbUNhcnQkKGRpc2hJZCwgYW1vdW50KSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucHV0KCcvY2FydC9yZW1vdmUnLCB7XHJcbiAgICAgIGRpc2hJZDogZGlzaElkLFxyXG4gICAgICBjYXJ0SWQ6IHRoaXMuY2FydElELFxyXG4gICAgICBhbW91bnQ6IGFtb3VudFxyXG4gICAgfSlcclxuICAgICAgLnBpcGUodGFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgdGhpcy5zZXRDYXJ0SWQocmVzdWx0LmNhcnQuY2FydElkKTtcclxuICAgICAgICB0aGlzLmNhcnQubmV4dChyZXN1bHQuY2FydCk7XHJcbiAgICAgICAgdGhpcy5jYXJ0SUQgPSByZXN1bHQuY2FydC5jYXJ0SWQ7XHJcbiAgICAgIH0pKTtcclxuXHJcbiAgfVxyXG5cclxuICByZW1vdmVEaXNoRnJvbUNhcnQoZGlzaElkLCBhbW91bnQpIHtcclxuICAgIHRoaXMubmV0LnB1dCgnL2NhcnQvcmVtb3ZlJywge1xyXG4gICAgICBkaXNoSWQ6IGRpc2hJZCxcclxuICAgICAgY2FydElkOiB0aGlzLmNhcnRJRCxcclxuICAgICAgYW1vdW50OiBhbW91bnRcclxuICAgIH0pLnN1YnNjcmliZShcclxuICAgICAgcmVzdWx0ID0+IHtcclxuICAgICAgICB0aGlzLnNldENhcnRJZChyZXN1bHQuY2FydC5jYXJ0SWQpO1xyXG4gICAgICAgIHRoaXMuY2FydC5uZXh0KHJlc3VsdC5jYXJ0KTtcclxuICAgICAgICB0aGlzLmNhcnRJRCA9IHJlc3VsdC5jYXJ0LmNhcnRJZDtcclxuICAgICAgICAvKnRoaXMuZXZlbnRlci5lbWl0TWVzc2FnZUV2ZW50KFxyXG4gICAgICAgICBuZXcgRXZlbnRNZXNzYWdlKCdzdWNjZXNzJywgJ9Cj0YHQv9C10YUnLCAn0JHQu9GO0LTQviDRg9GB0L/QtdGI0L3QviDRg9C00LDQu9C10L3QvicpXHJcbiAgICAgICAgICk7Ki9cclxuXHJcbiAgICAgIH0sICgpID0+IHtcclxuICAgICAgICAvKnRoaXMuZXZlbnRlci5lbWl0TWVzc2FnZUV2ZW50KFxyXG4gICAgICAgICBuZXcgRXZlbnRNZXNzYWdlKCdlcnJvcicsICfQntGI0LjQsdC60LAnLCAn0J3QtSDRg9C00LDQu9C+0YHRjCDRg9C00LDQu9C40YLRjCDQsdC70Y7QtNC+JylcclxuICAgICAgICAgKSovXHJcbiAgICAgIH0pO1xyXG5cclxuICB9XHJcblxyXG4gIGNoZWNrb3V0Q2FydChkYXRhKSB7XHJcbiAgICBsZXQgb3JkZXIgPSB7XHJcbiAgICAgIGNhcnRJZDogdGhpcy5jYXJ0SUQsXHJcbiAgICAgIGFkZHJlc3M6IHtcclxuICAgICAgICBzdHJlZXRJZDogZGF0YS5zdHJlZXQuaWQsXHJcbiAgICAgICAgaG9tZTogZGF0YS5ob3VzZSxcclxuICAgICAgICBob3VzaW5nOiBkYXRhLmhvdXNpbmcsXHJcbiAgICAgICAgLy8gaW5kZXg6IFwiMTI3OFwiLFxyXG4gICAgICAgIGVudHJhbmNlOiBkYXRhLmVudHJhbmNlLFxyXG4gICAgICAgIGZsb29yOiBkYXRhLmZsb29yLFxyXG4gICAgICAgIGFwYXJ0bWVudDogZGF0YS5hcGFydG1lbnRcclxuICAgICAgfSxcclxuXHJcbiAgICAgIGN1c3RvbWVyOiB7XHJcbiAgICAgICAgcGhvbmU6IGRhdGEucGhvbmUsXHJcbiAgICAgICAgbmFtZTogZGF0YS5uYW1lLFxyXG4gICAgICAgIG1haWw6IGRhdGEuZW1haWwgfHwgdW5kZWZpbmVkXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICByZXR1cm4gdGhpcy5vcmRlckNhcnQob3JkZXIpO1xyXG5cclxuICB9XHJcblxyXG4gIG9yZGVyQ2FydChkYXRhKSB7XHJcbiAgICByZXR1cm4gdGhpcy5uZXQucG9zdCgnL29yZGVyJywgZGF0YSlcclxuICAgICAgLnBpcGUoXHJcbiAgICAgICAgdGFwKFxyXG4gICAgICAgICAgcmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zZXRDYXJ0SWQocmVzdWx0LmNhcnQuY2FydElkKTtcclxuICAgICAgICAgICAgdGhpcy5jYXJ0Lm5leHQocmVzdWx0LmNhcnQpO1xyXG4gICAgICAgICAgICB0aGlzLmNhcnRJRCA9IHJlc3VsdC5jYXJ0LmNhcnRJZDtcclxuXHJcbiAgICAgICAgICAgIC8qdGhpcy5ldmVudGVyLmVtaXRNZXNzYWdlRXZlbnQoXHJcbiAgICAgICAgICAgICBuZXcgRXZlbnRNZXNzYWdlKCdzdWNjZXNzJywgJ9Cj0YHQv9C10YUnLCAn0JfQsNC60LDQtyDRg9C/0LXRiNC90L4g0L7RhNC+0YDQvNC70LXQvScpXHJcbiAgICAgICAgICAgICApOyovXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcItCe0YjQuNCx0LrQsCDQvtGE0L7RgNC80LvQtdC90LjRjyFcIiwgZXJyb3IpO1xyXG4gICAgICAgICAgICBpZiAoZXJyb3IuZXJyb3IgJiYgZXJyb3IuZXJyb3IuY2FydCkge1xyXG4gICAgICAgICAgICAgIHRoaXMuc2V0Q2FydElkKGVycm9yLmVycm9yLmNhcnQuY2FydElkKTtcclxuICAgICAgICAgICAgICB0aGlzLmNhcnQubmV4dChlcnJvci5lcnJvci5jYXJ0KTtcclxuICAgICAgICAgICAgICB0aGlzLmNhcnRJRCA9IGVycm9yLmVycm9yLmNhcnQuY2FydElkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8qaWYgKGVycm9yLm1lc3NhZ2UpIHtcclxuICAgICAgICAgICAgICB0aGlzLmV2ZW50ZXIuZW1pdE1lc3NhZ2VFdmVudChcclxuICAgICAgICAgICAgICAgIG5ldyBFdmVudE1lc3NhZ2UoZXJyb3IubWVzc2FnZS50eXBlLCBlcnJvci5tZXNzYWdlLnRpdGxlLCBlcnJvci5tZXNzYWdlLmJvZHkpXHJcbiAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0aGlzLmV2ZW50ZXIuZW1pdE1lc3NhZ2VFdmVudChcclxuICAgICAgICAgICAgICAgIG5ldyBFdmVudE1lc3NhZ2UoJ2Vycm9yJywgJ9Ce0YjQuNCx0LrQsCcsICfQndC1INGD0LTQsNC70L7RgdGMINC+0YTQvtGA0LzQuNGC0Ywg0LfQsNC60LDQtycpXHJcbiAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSovXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKVxyXG4gICAgICApO1xyXG4gIH1cclxuXHJcbiAgY2hlY2tTdHJlZXRWMihkYXRhKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLm5ldC5wb3N0KCcvY2hlY2snLCBkYXRhKVxyXG4gICAgICAucGlwZShcclxuICAgICAgICB0YXAoXHJcbiAgICAgICAgICByZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnNldENhcnRJZChyZXN1bHQuY2FydC5jYXJ0SWQpO1xyXG4gICAgICAgICAgICB0aGlzLmNhcnQubmV4dChyZXN1bHQuY2FydCk7XHJcbiAgICAgICAgICAgIHRoaXMuY2FydElEID0gcmVzdWx0LmNhcnQuY2FydElkO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgICgpID0+IHt9XHJcbiAgICAgICAgKVxyXG4gICAgICApO1xyXG4gIH1cclxuXHJcbiAgY2hlY2tTdHJlZXQoZGF0YSk6IHZvaWQge1xyXG5cclxuICAgIHRoaXMubmV0LnBvc3QoJy9jaGVjaycsIGRhdGEpLnN1YnNjcmliZShcclxuICAgICAgcmVzID0+IHtcclxuICAgICAgICB0aGlzLnNldENhcnRJZChyZXMuY2FydC5jYXJ0SWQpO1xyXG4gICAgICAgIHRoaXMuY2FydC5uZXh0KHJlcy5jYXJ0KTtcclxuICAgICAgICB0aGlzLmNhcnRJRCA9IHJlcy5jYXJ0LmNhcnRJZDtcclxuICAgICAgfSwgZXJyb3IgPT4ge1xyXG4gICAgICAgIGlmIChlcnJvci5lcnJvcikge1xyXG4gICAgICAgICAgaWYgKGVycm9yLmVycm9yLmNhcnQpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRDYXJ0SWQoZXJyb3IuZXJyb3IuY2FydC5jYXJ0SWQpO1xyXG4gICAgICAgICAgICB0aGlzLmNhcnQubmV4dChlcnJvci5lcnJvci5jYXJ0KTtcclxuICAgICAgICAgICAgdGhpcy5jYXJ0SUQgPSBlcnJvci5lcnJvci5jYXJ0LmNhcnRJZDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8qdGhpcy5ldmVudGVyLmVtaXRNZXNzYWdlRXZlbnQoXHJcbiAgICAgICAgICAgbmV3IEV2ZW50TWVzc2FnZShlcnJvci5lcnJvci5tZXNzYWdlLnR5cGUsIGVycm9yLmVycm9yLm1lc3NhZ2UudGl0bGUsIGVycm9yLmVycm9yLm1lc3NhZ2UuYm9keSlcclxuICAgICAgICAgICApOyovXHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgfVxyXG5cclxuICBzZXRDYXJ0SWQoY2FydElEKSB7XHJcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnY2FydElEJywgY2FydElEKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUNhcnRJZCgpIHtcclxuICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKCdjYXJ0SUQnKTtcclxuICB9XHJcblxyXG4gIHVzZXJDYXJ0KCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5jYXJ0O1xyXG4gIH1cclxuXHJcbiAgc2V0TW9kaWZpcmVzKG1vZGlmaXJlcywgbWVzc2FnZXM/OiBFdmVudE1lc3NhZ2VbXSk6IHZvaWQge1xyXG4gICAgdGhpcy5tb2RpZmlyZXMubmV4dChtb2RpZmlyZXMpO1xyXG4gICAgaWYgKG1lc3NhZ2VzKSB7XHJcbiAgICAgIHRoaXMubW9kaWZpcmVzTWVzc2FnZS5uZXh0KG1lc3NhZ2VzKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBnZXRNb2RpZmlyZXMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLm1vZGlmaXJlcy5waXBlKCk7XHJcbiAgfVxyXG5cclxuICBwcm9kdWN0SW5DYXJ0KHByb2R1Y3Q6IERpc2hMaXN0SXRlbSkge1xyXG4gICAgcmV0dXJuIHRoaXMuY2FydC5waXBlKFxyXG4gICAgICBmaWx0ZXIoY2FydCA9PiAnY2FydElkJyBpbiBjYXJ0KSxcclxuICAgICAgbWFwKGNhcnQgPT4ge1xyXG4gICAgICAgIHJldHVybiAhIShjYXJ0ICYmIGNhcnQ/LmRpc2hlcz8uZmluZChkaXNoSW5DYXJ0ID0+IGRpc2hJbkNhcnQuZGlzaC5pZCA9PT0gcHJvZHVjdC5pZCkpXHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0UGlja3VwUG9pbnRzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LmdldDxQaWNrdXBQb2ludFtdPignL3BpY2t1cGFkZHJlc2VzP2NhcnRJZD1zdHJpbmcnKTtcclxuICB9XHJcblxyXG4gIGdldFBheW1lbnRNZXRob2RzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmV0LmdldDxQYXltZW50TWV0aG9kW10+KCcvcGF5bWVudG1ldGhvZHMnKTtcclxuICB9XHJcblxyXG59XHJcblxyXG5kZWNsYXJlIGludGVyZmFjZSBQaWNrdXBQb2ludCB7XHJcbiAgaWQ6IHN0cmluZztcclxuICB0aXRsZTogc3RyaW5nO1xyXG4gIGFkZHJlc3M6IHN0cmluZztcclxuICBvcmRlcjogbnVtYmVyO1xyXG4gIGVuYWJsZTogYm9vbGVhbjtcclxuICBjcmVhdGVkQXQ6IHN0cmluZztcclxuICB1cGRhdGVkQXQ6IHN0cmluZztcclxufVxyXG5cclxuZGVjbGFyZSBpbnRlcmZhY2UgUGF5bWVudE1ldGhvZCB7XHJcbiAgaWlrb1BheW1lbnRNZXRob2Q6IGFueSxcclxuICBpZDogc3RyaW5nLFxyXG4gIHRpdGxlOiBzdHJpbmcsXHJcbiAgdHlwZTogc3RyaW5nLFxyXG4gIGFkYXB0ZXI6IHN0cmluZyxcclxuICBvcmRlcjogbnVtYmVyLFxyXG4gIGRlc2NyaXB0aW9uOiBzdHJpbmcsXHJcbiAgZW5hYmxlOiBib29sZWFuLFxyXG4gIGNyZWF0ZWRBdDogc3RyaW5nLFxyXG4gIHVwZGF0ZWRBdDogc3RyaW5nXHJcbn1cclxuXHJcbmRlY2xhcmUgaW50ZXJmYWNlIERpc2hJbkNhcnQge1xyXG4gIGFkZGVkQnk6IHN0cmluZztcclxuICBhbW91bnQ6IG51bWJlcjtcclxuICBjYXJ0OiBzdHJpbmc7XHJcbiAgY29tbWVudDogc3RyaW5nO1xyXG4gIGNyZWF0ZWRBdDogc3RyaW5nO1xyXG4gIGRpc2g6IERpc2hMaXN0SXRlbTtcclxuICBpZDogbnVtYmVyO1xyXG4gIGl0ZW1Ub3RhbDogbnVtYmVyO1xyXG4gIG1vZGlmaWVyczogYW55W107XHJcbiAgcGFyZW50OiBhbnk7XHJcbiAgdG90YWxXZWlnaHQ6IG51bWJlcjtcclxuICB1bmlxdWVJdGVtczogbnVtYmVyO1xyXG4gIHVwZGF0ZWRBdDogc3RyaW5nO1xyXG4gIHdlaWdodDogbnVtYmVyO1xyXG59XHJcblxyXG5kZWNsYXJlIGludGVyZmFjZSBDYXJ0IHtcclxuICBhZGRyZXNzOiBhbnlcclxuICBjYXJ0SWQ6IHN0cmluZ1xyXG4gIGNhcnRUb3RhbDogbnVtYmVyXHJcbiAgY29tbWVudDogc3RyaW5nXHJcbiAgY3JlYXRlZEF0OiBzdHJpbmdcclxuICBjdXN0b21lcjogc3RyaW5nXHJcbiAgZGVsaXZlcnk6IGFueVxyXG4gIGRlbGl2ZXJ5RGVzY3JpcHRpb246IHN0cmluZ1xyXG4gIGRlbGl2ZXJ5SXRlbTogYW55XHJcbiAgZGVsaXZlcnlTdGF0dXM6IGFueVxyXG4gIGRpc2hlczogRGlzaEluQ2FydFtdXHJcbiAgZGlzaGVzQ291bnQ6IG51bWJlclxyXG4gIGhpc3Rvcnk6IGFueVxyXG4gIGlkOiBzdHJpbmdcclxuICBtZXNzYWdlOiBhbnlcclxuICBtb2RpZmllcnM6IGFueVxyXG4gIG5hbWVPZk1vZGVsOiBhbnlcclxuICBwZXJzb25zQ291bnQ6IG51bWJlclxyXG4gIHByb2JsZW06IGJvb2xlYW5cclxuICBybXNJZDogc3RyaW5nXHJcbiAgc2VsZkRlbGl2ZXJ5OiBib29sZWFuXHJcbiAgc2VuZFRvSWlrbzogYm9vbGVhblxyXG4gIHN0YXRlOiBzdHJpbmdcclxuICB0b3RhbFdlaWdodDogc3RyaW5nXHJcbiAgdW5pcXVlRGlzaGVzOiBzdHJpbmdcclxuICB1cGRhdGVkQXQ6IHN0cmluZ1xyXG4gIHVzZXI6IGFueVxyXG4gIEZyZWVEZWxpdmVyeUZyb21NZXNzYWdlOiBzdHJpbmdcclxuICBkYXRlOiBudWxsXHJcbiAgZGVsaXZlcnlUaW1lTWVzc2FnZTogc3RyaW5nXHJcbiAgZGVsaXZlcnlUb3RhbDogbnVtYmVyXHJcbiAgZGlzY291bnRUb3RhbDogbnVtYmVyXHJcbiAgaXNQYXltZW50UHJvbWlzZTogYm9vbGVhblxyXG4gIG9yZGVyRGF0ZTogc3RyaW5nXHJcbiAgb3JkZXJEYXRlTGltaXQ6IHN0cmluZ1xyXG4gIG9yZGVyVG90YWw6IG51bWJlclxyXG4gIHBhaWQ6IGJvb2xlYW5cclxuICBwYXltZW50TWV0aG9kOiBzdHJpbmdcclxuICBwYXltZW50TWV0aG9kVGl0bGU6IHN0cmluZ1xyXG4gIHJlY29tbWVuZHM6IERpc2hMaXN0SXRlbVtdO1xyXG4gIHJtc0RlbGl2ZXJlZDogYm9vbGVhblxyXG4gIHJtc0RlbGl2ZXJ5RGF0ZTogbnVsbFxyXG4gIHJtc0Vycm9yQ29kZTogbnVsbFxyXG4gIHJtc0Vycm9yTWVzc2FnZTogbnVsbFxyXG4gIHJtc09yZGVyRGF0YTogbnVsbFxyXG4gIHJtc09yZGVyTnVtYmVyOiBudWxsXHJcbiAgcm1zU3RhdHVzQ29kZTogbnVsbFxyXG4gIHNlbGZTZXJ2aWNlOiBib29sZWFuXHJcbiAgc2hvcnRJZDogc3RyaW5nXHJcbiAgdG90YWw6IG51bWJlclxyXG4gIHVudGlsRnJlZURlbGl2ZXJ5TWVzc2FnZTogc3RyaW5nXHJcbn1cclxuXHJcbmRlY2xhcmUgaW50ZXJmYWNlIERpc2hMaXN0SXRlbSB7XHJcbiAgYWRkaXRpb25hbEluZm86IGFueVxyXG4gIGJhbGFuY2U6IG51bWJlclxyXG4gIGNhcmJvaHlkcmF0ZUFtb3VudDogbnVtYmVyXHJcbiAgY2FyYm9oeWRyYXRlRnVsbEFtb3VudDogbnVtYmVyXHJcbiAgY29kZTogc3RyaW5nXHJcbiAgY3JlYXRlZEF0OiBzdHJpbmdcclxuICBkZXNjcmlwdGlvbjogc3RyaW5nXHJcbiAgZGlmZmVyZW50UHJpY2VzT246IGFueVtdXHJcbiAgZG9Ob3RQcmludEluQ2hlcXVlOiBib29sZWFuXHJcbiAgZW5lcmd5QW1vdW50OiBudW1iZXJcclxuICBlbmVyZ3lGdWxsQW1vdW50OiBudW1iZXJcclxuICBmYXRBbW91bnQ6IG51bWJlclxyXG4gIGZhdEZ1bGxBbW91bnQ6IG51bWJlclxyXG4gIGZpYmVyQW1vdW50OiBudW1iZXJcclxuICBmaWJlckZ1bGxBbW91bnQ6IG51bWJlclxyXG4gIGdyb3VwSWQ6IGFueVxyXG4gIGdyb3VwTW9kaWZpZXJzOiBbXVxyXG4gIGhhc2g6IG51bWJlclxyXG4gIGlkOiBzdHJpbmdcclxuICBpbWFnZXM6IERpc2hJbWFnZUl0ZW1bXVxyXG4gIGltYWdlc0xpc3Q6IERpc2hJbWFnZUl0ZW1bXVxyXG4gIGlzRGVsZXRlZDogYm9vbGVhblxyXG4gIGlzSW5jbHVkZWRJbk1lbnU6IGJvb2xlYW5cclxuICBtZWFzdXJlVW5pdDogc3RyaW5nXHJcbiAgbW9kaWZpZXJzOiBEaXNoTW9kaWZpZXJbXVxyXG4gIG5hbWU6IHN0cmluZ1xyXG4gIG9yZGVyOiBudW1iZXJcclxuICBwYXJlbnRHcm91cDogc3RyaW5nXHJcbiAgcHJpY2U6IG51bWJlclxyXG4gIHByb2R1Y3RDYXRlZ29yeUlkOiBzdHJpbmdcclxuICBwcm9oaWJpdGVkVG9TYWxlT246IGFueVtdXHJcbiAgcm1zSWQ6IHN0cmluZ1xyXG4gIHNlb0Rlc2NyaXB0aW9uOiBhbnlcclxuICBzZW9LZXl3b3JkczogYW55XHJcbiAgc2VvVGV4dDogYW55XHJcbiAgc2VvVGl0bGU6IGFueVxyXG4gIHNsdWc6IHN0cmluZ1xyXG4gIHRhZ3M6IGFueVtdXHJcbiAgdGFnc0xpc3Q6IGFueVtdXHJcbiAgdHlwZTogc3RyaW5nXHJcbiAgdXBkYXRlZEF0OiBzdHJpbmdcclxuICB1c2VCYWxhbmNlRm9yU2VsbDogYm9vbGVhblxyXG4gIHdlaWdodDogbnVtYmVyXHJcbn1cclxuXHJcbmRlY2xhcmUgaW50ZXJmYWNlIERpc2hJbWFnZVVybHMge1xyXG4gIGxhcmdlOiBzdHJpbmdcclxuICBvcmlnaW46IHN0cmluZ1xyXG4gIHNtYWxsOiBzdHJpbmdcclxufVxyXG5cclxuZGVjbGFyZSBpbnRlcmZhY2UgRGlzaEltYWdlSXRlbSB7XHJcbiAgY3JlYXRlZEF0OiBzdHJpbmdcclxuICBncm91cDogYW55XHJcbiAgaWQ6IHN0cmluZ1xyXG4gIGltYWdlczogRGlzaEltYWdlVXJsc1xyXG4gIHVwZGF0ZWRBdDogc3RyaW5nXHJcbiAgdXBsb2FkRGF0ZTogc3RyaW5nXHJcbn1cclxuXHJcbmRlY2xhcmUgaW50ZXJmYWNlIERpc2hCYXNlTW9kaWZpZXIge1xyXG4gIG1heEFtb3VudDogbnVtYmVyXHJcbiAgbWluQW1vdW50OiBudW1iZXJcclxuICBtb2RpZmllcklkOiBzdHJpbmdcclxuICByZXF1aXJlZDogYm9vbGVhblxyXG59XHJcblxyXG5kZWNsYXJlIGludGVyZmFjZSBEaXNoTW9kaWZpZXIgZXh0ZW5kcyBEaXNoQmFzZU1vZGlmaWVyIHtcclxuICBjaGlsZE1vZGlmaWVyczogRGlzaENoaWxkTW9kaWZpZXJbXVxyXG4gIGNoaWxkTW9kaWZpZXJzSGF2ZU1pbk1heFJlc3RyaWN0aW9uczogYm9vbGVhblxyXG4gIGdyb3VwOiBEaXNoTGlzdEl0ZW1cclxufVxyXG5cclxuZGVjbGFyZSBpbnRlcmZhY2UgRGlzaENoaWxkTW9kaWZpZXIgZXh0ZW5kcyBEaXNoQmFzZU1vZGlmaWVyIHtcclxuICBkZWZhdWx0QW1vdW50OiBudW1iZXJcclxuICBoaWRlSWZEZWZhdWx0QW1vdW50OiBib29sZWFuXHJcbiAgZGlzaDogRGlzaExpc3RJdGVtXHJcbn1cclxuXHJcbmRlY2xhcmUgaW50ZXJmYWNlIFdvcmtUaW1lQmFzZSB7XHJcbiAgc3RhcnQ6IHN0cmluZztcclxuICBzdG9wOiBzdHJpbmc7XHJcbiAgYnJlYWs6IHN0cmluZztcclxufVxyXG5cclxuZGVjbGFyZSBpbnRlcmZhY2UgV29ya1RpbWUgZXh0ZW5kcyBXb3JrVGltZUJhc2Uge1xyXG4gIGRheU9mV2Vlazogc3RyaW5nXHJcbiAgc2VsZlNlcnZpY2U6IFdvcmtUaW1lQmFzZVxyXG59XHJcblxyXG5kZWNsYXJlIGludGVyZmFjZSBSZXN0cmljdGlvbnNPcmRlciB7XHJcbiAgbWluRGVsaXZlcnlUaW1lOiBzdHJpbmdcclxuICBwZXJpb2RQb3NzaWJsZUZvck9yZGVyOiBudW1iZXJcclxuICB0aW1lem9uZTogc3RyaW5nXHJcbiAgd29ya1RpbWU6IFdvcmtUaW1lW11cclxufVxyXG5cclxuIl19